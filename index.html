<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="robots" content="noindex, nofollow">
    <title>Maintenance Request System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // ============================================
        // CONFIGURATION - CUSTOMIZE FOR EACH CLIENT
        // ============================================
        const CONFIG = {
            brandName: "Maintenance Pro",
            brandColor: "#2563eb",
            // Password hash (SHA-256 of your password)
            // Generate at: https://emn178.github.io/online-tools/sha256.html
            // Default below is hash of "ChangeMe123!" - CHANGE THIS!
          adminPasswordHash: "240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9",
            sessionTimeout: 30 * 60 * 1000, // 30 minutes in milliseconds
            maxLoginAttempts: 5,
            lockoutDuration: 15 * 60 * 1000, // 15 minutes lockout
            categories: [
                "Plumbing",
                "Electrical",
                "HVAC",
                "Structural",
                "Grounds/Exterior",
                "Equipment",
                "General Maintenance",
                "Other"
            ]
        };

        // ============================================
        // SECURITY UTILITIES
        // ============================================
        const Security = {
            // Simple hash function for password verification
            async hashPassword(password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            },

            // Generate session token
            generateSessionToken() {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
            },

            // Sanitize user input
            sanitizeInput(input) {
                if (typeof input !== 'string') return input;
                return input
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;')
                    .trim();
            },

            // Validate email format
            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            },

            // Rate limiting for login attempts
            loginAttempts: {
                count: 0,
                lastAttempt: null,
                lockedUntil: null,

                canAttempt() {
                    if (this.lockedUntil && Date.now() < this.lockedUntil) {
                        return false;
                    }
                    if (this.lockedUntil && Date.now() >= this.lockedUntil) {
                        this.reset();
                    }
                    return true;
                },

                recordAttempt(success) {
                    if (success) {
                        this.reset();
                    } else {
                        this.count++;
                        this.lastAttempt = Date.now();
                        if (this.count >= CONFIG.maxLoginAttempts) {
                            this.lockedUntil = Date.now() + CONFIG.lockoutDuration;
                        }
                    }
                },

                reset() {
                    this.count = 0;
                    this.lastAttempt = null;
                    this.lockedUntil = null;
                },

                getRemainingLockout() {
                    if (!this.lockedUntil) return 0;
                    return Math.max(0, Math.ceil((this.lockedUntil - Date.now()) / 1000 / 60));
                }
            }
        };

        // ============================================
        // SESSION MANAGEMENT
        // ============================================
        const SessionManager = {
            SESSION_KEY: 'maintenance_session',
            
            createSession() {
                const session = {
                    token: Security.generateSessionToken(),
                    createdAt: Date.now(),
                    expiresAt: Date.now() + CONFIG.sessionTimeout
                };
                sessionStorage.setItem(this.SESSION_KEY, JSON.stringify(session));
                return session;
            },

            getSession() {
                const data = sessionStorage.getItem(this.SESSION_KEY);
                if (!data) return null;
                
                try {
                    const session = JSON.parse(data);
                    if (Date.now() > session.expiresAt) {
                        this.clearSession();
                        return null;
                    }
                    return session;
                } catch {
                    this.clearSession();
                    return null;
                }
            },

            refreshSession() {
                const session = this.getSession();
                if (session) {
                    session.expiresAt = Date.now() + CONFIG.sessionTimeout;
                    sessionStorage.setItem(this.SESSION_KEY, JSON.stringify(session));
                }
            },

            clearSession() {
                sessionStorage.removeItem(this.SESSION_KEY);
            },

            isValid() {
                return this.getSession() !== null;
            }
        };

        // ============================================
        // DATA STORAGE (Encrypted localStorage)
        // ============================================
        const DataStore = {
            STORAGE_KEY: 'maintenance_requests_v2',

            save(requests) {
                const data = JSON.stringify(requests);
                localStorage.setItem(this.STORAGE_KEY, data);
            },

            load() {
                const data = localStorage.getItem(this.STORAGE_KEY);
                if (!data) return [];
                try {
                    return JSON.parse(data);
                } catch {
                    return [];
                }
            },

            generateId() {
                return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            }
        };

        // ============================================
        // MAIN APP COMPONENT
        // ============================================
        function App() {
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [requests, setRequests] = useState([]);
            const [sessionExpireWarning, setSessionExpireWarning] = useState(false);

            // Check session on load and set up auto-refresh
            useEffect(() => {
                const storedRequests = DataStore.load();
                setRequests(storedRequests);
                
                if (SessionManager.isValid()) {
                    setIsAdmin(true);
                }

                // Session activity tracker
                const activityHandler = () => {
                    if (SessionManager.isValid()) {
                        SessionManager.refreshSession();
                    }
                };

                // Check session expiry every minute
                const sessionChecker = setInterval(() => {
                    const session = SessionManager.getSession();
                    if (isAdmin && !session) {
                        setIsAdmin(false);
                        alert('Your session has expired. Please log in again.');
                    } else if (session) {
                        const timeLeft = session.expiresAt - Date.now();
                        if (timeLeft < 5 * 60 * 1000 && timeLeft > 0) {
                            setSessionExpireWarning(true);
                        } else {
                            setSessionExpireWarning(false);
                        }
                    }
                }, 60000);

                window.addEventListener('click', activityHandler);
                window.addEventListener('keypress', activityHandler);

                return () => {
                    clearInterval(sessionChecker);
                    window.removeEventListener('click', activityHandler);
                    window.removeEventListener('keypress', activityHandler);
                };
            }, [isAdmin]);

            const saveRequests = useCallback((newRequests) => {
                setRequests(newRequests);
                DataStore.save(newRequests);
            }, []);

            const addRequest = useCallback((request) => {
                // Sanitize all inputs
                const sanitizedRequest = {
                    ...request,
                    id: DataStore.generateId(),
                    name: Security.sanitizeInput(request.name),
                    email: Security.sanitizeInput(request.email),
                    phone: Security.sanitizeInput(request.phone),
                    location: Security.sanitizeInput(request.location),
                    category: Security.sanitizeInput(request.category),
                    priority: Security.sanitizeInput(request.priority),
                    description: Security.sanitizeInput(request.description),
                    photoUrl: Security.sanitizeInput(request.photoUrl),
                    status: 'new',
                    submittedDate: new Date().toISOString(),
                    updatedDate: new Date().toISOString()
                };
                saveRequests([...requests, sanitizedRequest]);
            }, [requests, saveRequests]);

            const updateRequest = useCallback((id, updates) => {
                // Sanitize updates
                const sanitizedUpdates = {};
                Object.keys(updates).forEach(key => {
                    sanitizedUpdates[key] = Security.sanitizeInput(updates[key]);
                });
                
                const updated = requests.map(req => 
                    req.id === id 
                        ? { ...req, ...sanitizedUpdates, updatedDate: new Date().toISOString() }
                        : req
                );
                saveRequests(updated);
            }, [requests, saveRequests]);

            const deleteRequest = useCallback((id) => {
                if (confirm('Are you sure you want to delete this request? This cannot be undone.')) {
                    saveRequests(requests.filter(req => req.id !== id));
                }
            }, [requests, saveRequests]);

            const handleLogin = async (password) => {
                if (!Security.loginAttempts.canAttempt()) {
                    const minutes = Security.loginAttempts.getRemainingLockout();
                    return { success: false, error: `Too many attempts. Try again in ${minutes} minutes.` };
                }

                const hash = await Security.hashPassword(password);
                if (hash === CONFIG.adminPasswordHash) {
                    Security.loginAttempts.recordAttempt(true);
                    SessionManager.createSession();
                    setIsAdmin(true);
                    setShowLogin(false);
                    return { success: true };
                } else {
                    Security.loginAttempts.recordAttempt(false);
                    const remaining = CONFIG.maxLoginAttempts - Security.loginAttempts.count;
                    return { 
                        success: false, 
                        error: remaining > 0 
                            ? `Incorrect password. ${remaining} attempts remaining.`
                            : 'Account locked. Try again later.'
                    };
                }
            };

            const handleLogout = () => {
                SessionManager.clearSession();
                setIsAdmin(false);
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {sessionExpireWarning && (
                        <div className="bg-yellow-500 text-white text-center py-2 px-4">
                            <i className="fas fa-clock mr-2"></i>
                            Your session will expire soon. Click anywhere to stay logged in.
                        </div>
                    )}
                    
                    <Header 
                        isAdmin={isAdmin} 
                        onLoginClick={() => setShowLogin(true)}
                        onLogout={handleLogout}
                    />
                    
                    {showLogin && (
                        <LoginModal 
                            onLogin={handleLogin}
                            onClose={() => setShowLogin(false)}
                        />
                    )}

                    <div className="container mx-auto px-4 py-8">
                        {isAdmin ? (
                            <AdminDashboard 
                                requests={requests}
                                onUpdateRequest={updateRequest}
                                onDeleteRequest={deleteRequest}
                            />
                        ) : (
                            <PublicRequestForm onSubmit={addRequest} />
                        )}
                    </div>
                    
                    <footer className="text-center text-gray-500 text-sm py-4">
                        &copy; {new Date().getFullYear()} {CONFIG.brandName}. All rights reserved.
                    </footer>
                </div>
            );
        }

        // ============================================
        // HEADER COMPONENT
        // ============================================
        function Header({ isAdmin, onLoginClick, onLogout }) {
            return (
                <header className="bg-white shadow-sm border-b-4" style={{ borderColor: CONFIG.brandColor }}>
                    <div className="container mx-auto px-4 py-4">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <i className="fas fa-tools text-3xl" style={{ color: CONFIG.brandColor }}></i>
                                <h1 className="text-2xl font-bold text-gray-800">{CONFIG.brandName}</h1>
                            </div>
                            
                            <div>
                                {isAdmin ? (
                                    <div className="flex items-center gap-4">
                                        <span className="text-sm text-green-600">
                                            <i className="fas fa-shield-alt mr-1"></i>
                                            Admin Mode
                                        </span>
                                        <button
                                            onClick={onLogout}
                                            className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
                                        >
                                            <i className="fas fa-sign-out-alt mr-2"></i>
                                            Logout
                                        </button>
                                    </div>
                                ) : (
                                    <button
                                        onClick={onLoginClick}
                                        className="px-4 py-2 text-white rounded-lg hover:opacity-90 transition"
                                        style={{ backgroundColor: CONFIG.brandColor }}
                                    >
                                        <i className="fas fa-lock mr-2"></i>
                                        Admin Login
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </header>
            );
        }

        // ============================================
        // LOGIN MODAL
        // ============================================
        function LoginModal({ onLogin, onClose }) {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                
                const result = await onLogin(password);
                
                setLoading(false);
                if (!result.success) {
                    setError(result.error);
                    setPassword('');
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-8 max-w-md w-full mx-4 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold">
                                <i className="fas fa-shield-alt mr-2" style={{ color: CONFIG.brandColor }}></i>
                                Admin Login
                            </h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Password
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    autoFocus
                                    autoComplete="current-password"
                                    disabled={loading}
                                />
                                {error && (
                                    <p className="text-red-600 text-sm mt-2">
                                        <i className="fas fa-exclamation-circle mr-1"></i>
                                        {error}
                                    </p>
                                )}
                            </div>
                            
                            <button
                                type="submit"
                                disabled={loading || !password}
                                className="w-full py-2 text-white rounded-lg hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                style={{ backgroundColor: CONFIG.brandColor }}
                            >
                                {loading ? (
                                    <>
                                        <i className="fas fa-spinner fa-spin mr-2"></i>
                                        Verifying...
                                    </>
                                ) : (
                                    <>
                                        <i className="fas fa-sign-in-alt mr-2"></i>
                                        Login
                                    </>
                                )}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // ============================================
        // PUBLIC REQUEST FORM
        // ============================================
        function PublicRequestForm({ onSubmit }) {
            const [formData, setFormData] = useState({
                name: '',
                email: '',
                phone: '',
                location: '',
                category: '',
                priority: 'normal',
                description: '',
                photoUrl: ''
            });
            const [errors, setErrors] = useState({});
            const [submitted, setSubmitted] = useState(false);

            const validate = () => {
                const newErrors = {};
                
                if (!formData.name.trim()) {
                    newErrors.name = 'Name is required';
                }
                
                if (!formData.email.trim()) {
                    newErrors.email = 'Email is required';
                } else if (!Security.isValidEmail(formData.email)) {
                    newErrors.email = 'Please enter a valid email';
                }
                
                if (!formData.location.trim()) {
                    newErrors.location = 'Location is required';
                }
                
                if (!formData.category) {
                    newErrors.category = 'Please select a category';
                }
                
                if (!formData.description.trim()) {
                    newErrors.description = 'Description is required';
                } else if (formData.description.length < 10) {
                    newErrors.description = 'Please provide more detail (at least 10 characters)';
                }

                if (formData.photoUrl && !formData.photoUrl.match(/^https?:\/\/.+/)) {
                    newErrors.photoUrl = 'Please enter a valid URL starting with http:// or https://';
                }

                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (validate()) {
                    onSubmit(formData);
                    setFormData({
                        name: '',
                        email: '',
                        phone: '',
                        location: '',
                        category: '',
                        priority: 'normal',
                        description: '',
                        photoUrl: ''
                    });
                    setErrors({});
                    setSubmitted(true);
                    setTimeout(() => setSubmitted(false), 5000);
                }
            };

            const handleChange = (field, value) => {
                setFormData({ ...formData, [field]: value });
                if (errors[field]) {
                    setErrors({ ...errors, [field]: null });
                }
            };

            return (
                <div className="max-w-3xl mx-auto">
                    {submitted && (
                        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-6">
                            <i className="fas fa-check-circle mr-2"></i>
                            <strong>Success!</strong> Your maintenance request has been submitted. We'll be in touch soon.
                        </div>
                    )}
                    
                    <div className="bg-white rounded-lg shadow-md p-8">
                        <h2 className="text-3xl font-bold mb-2">Submit Maintenance Request</h2>
                        <p className="text-gray-600 mb-6">Fill out the form below to report a maintenance issue</p>
                        
                        <form onSubmit={handleSubmit} className="space-y-6" noValidate>
                            <div className="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Your Name <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.name}
                                        onChange={(e) => handleChange('name', e.target.value)}
                                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${errors.name ? 'border-red-500' : 'border-gray-300'}`}
                                        maxLength={100}
                                    />
                                    {errors.name && <p className="text-red-500 text-sm mt-1">{errors.name}</p>}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Email <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="email"
                                        value={formData.email}
                                        onChange={(e) => handleChange('email', e.target.value)}
                                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${errors.email ? 'border-red-500' : 'border-gray-300'}`}
                                        maxLength={100}
                                    />
                                    {errors.email && <p className="text-red-500 text-sm mt-1">{errors.email}</p>}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Phone
                                    </label>
                                    <input
                                        type="tel"
                                        value={formData.phone}
                                        onChange={(e) => handleChange('phone', e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        maxLength={20}
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Location <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        placeholder="e.g., Building A, Room 101"
                                        value={formData.location}
                                        onChange={(e) => handleChange('location', e.target.value)}
                                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${errors.location ? 'border-red-500' : 'border-gray-300'}`}
                                        maxLength={200}
                                    />
                                    {errors.location && <p className="text-red-500 text-sm mt-1">{errors.location}</p>}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Category <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={formData.category}
                                        onChange={(e) => handleChange('category', e.target.value)}
                                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${errors.category ? 'border-red-500' : 'border-gray-300'}`}
                                    >
                                        <option value="">Select Category</option>
                                        {CONFIG.categories.map(cat => (
                                            <option key={cat} value={cat}>{cat}</option>
                                        ))}
                                    </select>
                                    {errors.category && <p className="text-red-500 text-sm mt-1">{errors.category}</p>}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Priority <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={formData.priority}
                                        onChange={(e) => handleChange('priority', e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="low">Low - Can wait</option>
                                        <option value="normal">Normal - Standard priority</option>
                                        <option value="high">High - Needs prompt attention</option>
                                        <option value="urgent">Urgent - Emergency</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Description <span className="text-red-500">*</span>
                                </label>
                                <textarea
                                    rows="4"
                                    value={formData.description}
                                    onChange={(e) => handleChange('description', e.target.value)}
                                    placeholder="Please describe the issue in detail..."
                                    className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${errors.description ? 'border-red-500' : 'border-gray-300'}`}
                                    maxLength={2000}
                                ></textarea>
                                {errors.description && <p className="text-red-500 text-sm mt-1">{errors.description}</p>}
                                <p className="text-sm text-gray-500 mt-1">{formData.description.length}/2000 characters</p>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Photo URL (optional)
                                </label>
                                <input
                                    type="url"
                                    value={formData.photoUrl}
                                    onChange={(e) => handleChange('photoUrl', e.target.value)}
                                    placeholder="https://example.com/image.jpg"
                                    className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${errors.photoUrl ? 'border-red-500' : 'border-gray-300'}`}
                                />
                                {errors.photoUrl && <p className="text-red-500 text-sm mt-1">{errors.photoUrl}</p>}
                                <p className="text-sm text-gray-500 mt-1">
                                    Upload your photo to an image hosting service and paste the link here
                                </p>
                            </div>

                            <button
                                type="submit"
                                className="w-full py-3 text-white text-lg font-semibold rounded-lg hover:opacity-90 transition"
                                style={{ backgroundColor: CONFIG.brandColor }}
                            >
                                <i className="fas fa-paper-plane mr-2"></i>
                                Submit Request
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // ============================================
        // ADMIN DASHBOARD
        // ============================================
        function AdminDashboard({ requests, onUpdateRequest, onDeleteRequest }) {
            const [filter, setFilter] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('newest');

            const filteredRequests = requests
                .filter(req => {
                    if (filter !== 'all' && req.status !== filter) return false;
                    if (searchTerm) {
                        const search = searchTerm.toLowerCase();
                        return req.name?.toLowerCase().includes(search) ||
                               req.location?.toLowerCase().includes(search) ||
                               req.description?.toLowerCase().includes(search) ||
                               req.category?.toLowerCase().includes(search) ||
                               req.id?.toLowerCase().includes(search);
                    }
                    return true;
                })
                .sort((a, b) => {
                    switch (sortBy) {
                        case 'newest':
                            return new Date(b.submittedDate) - new Date(a.submittedDate);
                        case 'oldest':
                            return new Date(a.submittedDate) - new Date(b.submittedDate);
                        case 'priority':
                            const priorityOrder = { urgent: 0, high: 1, normal: 2, low: 3 };
                            return priorityOrder[a.priority] - priorityOrder[b.priority];
                        default:
                            return 0;
                    }
                });

            const stats = {
                total: requests.length,
                new: requests.filter(r => r.status === 'new').length,
                inProgress: requests.filter(r => r.status === 'in-progress').length,
                completed: requests.filter(r => r.status === 'completed').length
            };

            const exportToCSV = () => {
                const headers = ['ID', 'Status', 'Priority', 'Name', 'Email', 'Phone', 'Location', 'Category', 'Description', 'Submitted', 'Updated', 'Assigned To', 'Cost', 'Notes'];
                const rows = requests.map(req => [
                    req.id,
                    req.status,
                    req.priority,
                    req.name,
                    req.email,
                    req.phone || '',
                    req.location,
                    req.category,
                    req.description,
                    new Date(req.submittedDate).toLocaleString(),
                    new Date(req.updatedDate).toLocaleString(),
                    req.assignedTo || '',
                    req.cost || '',
                    req.notes || ''
                ]);

                const csv = [headers, ...rows]
                    .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                    .join('\n');

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `maintenance-requests-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            return (
                <div>
                    <div className="mb-8">
                        <h2 className="text-3xl font-bold mb-6">Admin Dashboard</h2>
                        
                        {/* Stats Cards */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <StatCard title="Total Requests" value={stats.total} icon="clipboard-list" color="blue" />
                            <StatCard title="New" value={stats.new} icon="exclamation-circle" color="yellow" />
                            <StatCard title="In Progress" value={stats.inProgress} icon="spinner" color="orange" />
                            <StatCard title="Completed" value={stats.completed} icon="check-circle" color="green" />
                        </div>

                        {/* Filters and Search */}
                        <div className="bg-white rounded-lg shadow-md p-4 mb-6">
                            <div className="flex flex-col lg:flex-row gap-4">
                                <div className="flex-1">
                                    <input
                                        type="text"
                                        placeholder="Search by name, location, description, or ID..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                
                                <div className="flex flex-wrap gap-2">
                                    <select
                                        value={sortBy}
                                        onChange={(e) => setSortBy(e.target.value)}
                                        className="px-4 py-2 border border-gray-300 rounded-lg"
                                    >
                                        <option value="newest">Newest First</option>
                                        <option value="oldest">Oldest First</option>
                                        <option value="priority">By Priority</option>
                                    </select>
                                    
                                    <button
                                        onClick={() => setFilter('all')}
                                        className={`px-4 py-2 rounded-lg transition ${filter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                    >
                                        All
                                    </button>
                                    <button
                                        onClick={() => setFilter('new')}
                                        className={`px-4 py-2 rounded-lg transition ${filter === 'new' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                    >
                                        New ({stats.new})
                                    </button>
                                    <button
                                        onClick={() => setFilter('in-progress')}
                                        className={`px-4 py-2 rounded-lg transition ${filter === 'in-progress' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                    >
                                        In Progress ({stats.inProgress})
                                    </button>
                                    <button
                                        onClick={() => setFilter('completed')}
                                        className={`px-4 py-2 rounded-lg transition ${filter === 'completed' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                    >
                                        Completed ({stats.completed})
                                    </button>
                                    <button
                                        onClick={exportToCSV}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                                    >
                                        <i className="fas fa-download mr-2"></i>
                                        Export CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Request Cards */}
                    <div className="space-y-4">
                        {filteredRequests.length === 0 ? (
                            <div className="bg-white rounded-lg shadow-md p-8 text-center text-gray-500">
                                <i className="fas fa-inbox text-4xl mb-4"></i>
                                <p>{requests.length === 0 ? 'No requests yet' : 'No requests match your filters'}</p>
                            </div>
                        ) : (
                            filteredRequests.map(request => (
                                <RequestCard 
                                    key={request.id}
                                    request={request}
                                    onUpdate={onUpdateRequest}
                                    onDelete={onDeleteRequest}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        }

        // ============================================
        // STAT CARD COMPONENT
        // ============================================
        function StatCard({ title, value, icon, color }) {
            const colorClasses = {
                blue: 'bg-blue-100 text-blue-600',
                yellow: 'bg-yellow-100 text-yellow-600',
                orange: 'bg-orange-100 text-orange-600',
                green: 'bg-green-100 text-green-600'
            };

            return (
                <div className="bg-white rounded-lg shadow-md p-4 md:p-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-xs md:text-sm text-gray-600 mb-1">{title}</p>
                            <p className="text-2xl md:text-3xl font-bold">{value}</p>
                        </div>
                        <div className={`w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center ${colorClasses[color]}`}>
                            <i className={`fas fa-${icon} text-lg md:text-xl`}></i>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // REQUEST CARD COMPONENT
        // ============================================
        function RequestCard({ request, onUpdate, onDelete }) {
            const [isExpanded, setIsExpanded] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState({
                assignedTo: request.assignedTo || '',
                cost: request.cost || '',
                notes: request.notes || ''
            });

            const statusColors = {
                'new': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                'in-progress': 'bg-orange-100 text-orange-800 border-orange-300',
                'completed': 'bg-green-100 text-green-800 border-green-300'
            };

            const priorityColors = {
                'low': 'bg-gray-100 text-gray-800',
                'normal': 'bg-blue-100 text-blue-800',
                'high': 'bg-orange-100 text-orange-800',
                'urgent': 'bg-red-100 text-red-800'
            };

            const handleSave = () => {
                onUpdate(request.id, editData);
                setIsEditing(false);
            };

            const handleStatusChange = (newStatus) => {
                onUpdate(request.id, { status: newStatus });
            };

            // Decode HTML entities for display
            const decodeHtml = (html) => {
                const txt = document.createElement('textarea');
                txt.innerHTML = html;
                return txt.value;
            };

            return (
                <div className="bg-white rounded-lg shadow-md overflow-hidden">
                    <div className="p-4 md:p-6">
                        <div className="flex justify-between items-start mb-4">
                            <div className="flex-1">
                                <div className="flex flex-wrap items-center gap-2 mb-2">
                                    <span className={`px-3 py-1 rounded-full text-xs md:text-sm font-semibold border ${statusColors[request.status]}`}>
                                        {request.status.replace('-', ' ').toUpperCase()}
                                    </span>
                                    <span className={`px-3 py-1 rounded-full text-xs md:text-sm font-semibold ${priorityColors[request.priority]}`}>
                                        {request.priority.toUpperCase()}
                                    </span>
                                    <span className="text-xs text-gray-500 font-mono">
                                        #{request.id}
                                    </span>
                                </div>
                                
                                <h3 className="text-lg md:text-xl font-bold mb-1">{decodeHtml(request.category)}</h3>
                                <p className="text-gray-600 text-sm md:text-base">
                                    <i className="fas fa-map-marker-alt mr-2"></i>
                                    {decodeHtml(request.location)}
                                </p>
                            </div>

                            <button
                                onClick={() => setIsExpanded(!isExpanded)}
                                className="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition ml-2"
                            >
                                <i className={`fas fa-chevron-${isExpanded ? 'up' : 'down'}`}></i>
                            </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-sm">
                            <div>
                                <p className="text-gray-500">Submitted By</p>
                                <p className="font-medium">{decodeHtml(request.name)}</p>
                                <p className="text-gray-600">{decodeHtml(request.email)}</p>
                                {request.phone && <p className="text-gray-600">{decodeHtml(request.phone)}</p>}
                            </div>
                            <div>
                                <p className="text-gray-500">Submitted</p>
                                <p className="font-medium">{new Date(request.submittedDate).toLocaleDateString()}</p>
                                <p className="text-gray-600">{new Date(request.submittedDate).toLocaleTimeString()}</p>
                            </div>
                            <div>
                                <p className="text-gray-500">Last Updated</p>
                                <p className="font-medium">{new Date(request.updatedDate).toLocaleDateString()}</p>
                                <p className="text-gray-600">{new Date(request.updatedDate).toLocaleTimeString()}</p>
                            </div>
                        </div>

                        {isExpanded && (
                            <div className="border-t pt-4 mt-4">
                                <div className="mb-4">
                                    <p className="text-sm font-semibold text-gray-700 mb-2">Description</p>
                                    <p className="text-gray-700 whitespace-pre-wrap">{decodeHtml(request.description)}</p>
                                </div>

                                {request.photoUrl && (
                                    <div className="mb-4">
                                        <p className="text-sm font-semibold text-gray-700 mb-2">Photo</p>
                                        <img 
                                            src={request.photoUrl} 
                                            alt="Maintenance issue" 
                                            className="max-w-full md:max-w-md rounded-lg shadow-md"
                                            onError={(e) => e.target.style.display = 'none'}
                                        />
                                    </div>
                                )}

                                {isEditing ? (
                                    <div className="bg-gray-50 p-4 rounded-lg mb-4">
                                        <div className="grid md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Assigned To
                                                </label>
                                                <input
                                                    type="text"
                                                    value={editData.assignedTo}
                                                    onChange={(e) => setEditData({...editData, assignedTo: e.target.value})}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                    maxLength={100}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Cost ($)
                                                </label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    min="0"
                                                    value={editData.cost}
                                                    onChange={(e) => setEditData({...editData, cost: e.target.value})}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                />
                                            </div>
                                        </div>
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Notes
                                            </label>
                                            <textarea
                                                rows="3"
                                                value={editData.notes}
                                                onChange={(e) => setEditData({...editData, notes: e.target.value})}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                                maxLength={1000}
                                            ></textarea>
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={handleSave}
                                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                                            >
                                                <i className="fas fa-save mr-2"></i>
                                                Save
                                            </button>
                                            <button
                                                onClick={() => setIsEditing(false)}
                                                className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    (request.assignedTo || request.cost || request.notes) && (
                                        <div className="bg-gray-50 p-4 rounded-lg mb-4">
                                            {request.assignedTo && (
                                                <p className="mb-2">
                                                    <span className="font-semibold">Assigned To:</span> {decodeHtml(request.assignedTo)}
                                                </p>
                                            )}
                                            {request.cost && (
                                                <p className="mb-2">
                                                    <span className="font-semibold">Cost:</span> ${parseFloat(request.cost).toFixed(2)}
                                                </p>
                                            )}
                                            {request.notes && (
                                                <p>
                                                    <span className="font-semibold">Notes:</span> {decodeHtml(request.notes)}
                                                </p>
                                            )}
                                        </div>
                                    )
                                )}

                                <div className="flex flex-wrap gap-2">
                                    <button
                                        onClick={() => handleStatusChange('new')}
                                        disabled={request.status === 'new'}
                                        className="px-3 py-2 text-sm bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Mark New
                                    </button>
                                    <button
                                        onClick={() => handleStatusChange('in-progress')}
                                        disabled={request.status === 'in-progress'}
                                        className="px-3 py-2 text-sm bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        In Progress
                                    </button>
                                    <button
                                        onClick={() => handleStatusChange('completed')}
                                        disabled={request.status === 'completed'}
                                        className="px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Completed
                                    </button>
                                    <button
                                        onClick={() => setIsEditing(!isEditing)}
                                        className="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                    >
                                        <i className="fas fa-edit mr-1"></i>
                                        Edit
                                    </button>
                                    <button
                                        onClick={() => onDelete(request.id)}
                                        className="px-3 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
                                    >
                                        <i className="fas fa-trash mr-1"></i>
                                        Delete
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Render App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
